# ERC-4337 Account Creator 使用指南

## 🆕 **重要更新 (2025-01-19)**

**Salt功能已修复！** 现在您可以正确地使用不同的salt值创建多个合约账户：

- ✅ **Custom Salt模式**: 支持十六进制和十进制输入，自动格式转换
- ✅ **Random Salt模式**: 每次计算时生成新的随机salt
- ✅ **实时显示**: 显示当前使用的salt值和计算结果
- ✅ **调试信息**: 浏览器控制台显示详细的salt处理过程

**您不需要记住salt值** - 系统会自动保存所有创建的账户及其salt值！

## 功能概述

新增的 Account Creator 页面允许用户使用连接的钱包来创建 ERC-4337 智能账户，并自动为其提供初始资金。

## 功能特性

### 🎯 核心功能
- **工厂选择**: 支持 Simple Account 和 Alchemy Light Account 两种工厂
- **地址预估**: 使用 CREATE2 确定性计算合约账户地址
- **账户创建**: 调用工厂合约部署智能账户
- **自动转账**: 创建后自动转账 PNTs 和 ETH 到新账户
- **账户记录**: 将创建的账户信息保存到本地存储

### 🏭 支持的工厂合约

**Simple Account Factory**
- Sepolia: `0x91E60e0613810449d098b0b5Ec8b51A0FE8c8985` (v0.6)
- Mainnet: `0x15Ba39375ee2Ab563E8873C8390be6F2E2F50232`

**Alchemy Light Account Factory**
- Sepolia: `0x00004EC70002a32400f8ae005A26aeFe730D0A1E`
- Mainnet: `0x0000000000400CdFef5E2714E63d8040b700BC24` (v1.1.0)

### 🎯 EntryPoint 合约

**ERC-4337 EntryPoint v0.6.0**
- Sepolia: `0x5FF137D4b0FDCD49DcA30c7CF57E578a026d2789`
- Mainnet: `0x0000000071727De22E5E9d8BAf0edAc6f37da032`

## 使用步骤

### 1. 连接钱包
- 点击 "Connect Wallet" 连接您的 MetaMask
- 确保您在 Sepolia 测试网

### 2. 切换到 Account Creator 页面
- 在页面顶部点击 "Account Creator" 按钮

### 3. 选择工厂类型
- **Simple Account**: 官方 ERC-4337 实现，功能完整
- **Alchemy Light Account**: Gas 优化版本，部署成本更低

### 4. 配置 Salt 值
- **Custom Salt**: 使用自定义salt值，可以手动输入或点击"随机生成"
- **Random Salt**: 每次计算地址时自动生成新的随机salt，确保地址唯一性
- Salt 决定了最终的合约账户地址，同一个私钥+不同salt=不同账户

### 5. 计算预测地址
- 点击 "🔍 Calculate Address" 按钮
- 系统使用 CREATE2 确定性计算合约账户地址
- 可以点击链接在 Etherscan 上查看地址

### 6. 创建账户
- 点击 "🚀 Create Account" 按钮
- 等待交易确认，账户部署完成

### 7. 转账资金
创建账户后，可以为新账户转账资金：

**转账 PNTs**
- 默认金额: 100 PNTs
- 可自定义金额
- 从您的钱包转账到新创建的账户

**转账 ETH**
- 默认金额: 0.01 ETH
- 可自定义金额
- 从您的钱包转账到新创建的账户

### 8. 查看结果
- 成功后会显示交易哈希
- 点击链接可在 Etherscan 上查看交易详情
- 创建的账户会自动保存到本地记录

## 🔑 Salt 管理与账户控制

### 📝 Salt 记忆问题

**您不需要记住salt值！** 系统会自动保存您创建的每个账户及其对应的salt值：

- **账户记录**: 每个创建的账户都会保存在浏览器localStorage中
- **Salt 追踪**: 记录显示每个账户使用的salt值（前10个字符）
- **重复创建**: 如果需要重新创建相同地址的账户，可以从记录中找到对应的salt值

### 🔄 如何找回之前的账户

1. **查看账户列表**: 在页面底部查看"Created Accounts"区域
2. **复制Salt值**: 从账户详情中找到salt值（如: `0x1a2b3c4d...`）
3. **重新创建**:
   - 切换到Custom Salt模式
   - 粘贴salt值到输入框
   - 点击"Calculate Address"验证地址
   - 点击"Create Account"重新部署

### ⚠️ 重要提醒

- **Random Salt模式**: 每次计算都会生成新salt，无法找回之前的salt值
- **Custom Salt模式**: 只有手动保存salt值才能重新创建相同账户
- **账户记录**: 保存在浏览器本地，清除浏览器数据会丢失记录

### 📚 技术原理
- **CREATE2**: 使用确定性地址生成，确保相同参数总是产生相同地址
- **Salt 参数**: 32字节随机数，用于区分不同的合约账户
- **多账户机制**: 同一个私钥通过不同salt可以创建多个独立的合约账户

### 🎯 使用场景
- **隔离资金**: 为不同用途创建独立的账户
- **批量操作**: 一次创建多个账户用于不同的业务场景
- **测试环境**: 在测试网中快速创建多个测试账户

### ⚙️ Salt 配置选项

**Custom Salt 模式**:
- 手动输入salt值（支持十六进制 `0x...` 或十进制数字）
- 可以重复使用相同salt创建相同地址的账户
- 支持"随机生成"按钮快速填充随机值
- 自动格式化输入（十进制自动转换为32字节十六进制）

**Random Salt 模式**:
- 每次点击"Calculate Address"时自动生成新的32字节随机salt
- 确保每次创建的账户地址都是唯一的
- 适合需要大量独立账户的场景
- 显示"随机生成 (每次计算时生成新值)"提示

### ⚠️ **重要提醒：地址区分**

**工厂合约地址 ≠ 智能账户地址**

- **工厂合约地址**: 显示在页面底部，用于部署智能账户的工厂合约
- **智能账户地址**: 通过计算得到的您的ERC-4337智能账户地址
- **区别**: 每次计算都会生成不同的智能账户地址，而工厂地址是固定的

如果您看到地址不变，请确保您查看的是"🎯 Predicted Smart Account Address"区域，而不是底部的工厂地址。

### 💡 最佳实践
- **生产环境**: 使用Random Salt确保账户地址唯一性
- **开发测试**: 使用Custom Salt便于重现和调试
- **资金管理**: 为不同业务场景创建独立的合约账户

## 账户记录

### 📁 存储位置
- 使用浏览器 `localStorage` 存储
- 存储键名: `createdAccounts`

### 📊 记录信息
每个创建的账户包含以下信息：
```javascript
{
  address: "0x...",        // 合约账户地址
  factory: "simple",       // 使用的工厂类型
  factoryName: "Simple Account", // 工厂名称
  salt: "0x...",          // 创建时使用的salt值
  createdAt: "2024-...",   // 创建时间
  txHash: "0x...",        // 创建交易哈希
  owner: "0x...",         // 所有者地址
  network: "sepolia"      // 网络名称
}
```

### 🔄 持久化
- 账户记录在浏览器本地持久化
- 页面刷新后记录仍然存在
- 清除浏览器数据会丢失记录

## 技术实现

### 🔧 核心组件
- `AccountCreatorPage.jsx`: 主页面组件
- 集成到现有 `App.jsx` 中，通过页面切换实现

### 🎨 界面设计
- 与现有页面保持一致的设计风格
- 响应式布局，支持移动端
- 清晰的状态指示和用户反馈

### 🔗 合约交互
- 使用 ethers.js 与工厂合约交互
- 支持多种 ERC-4337 账户工厂
- 自动处理交易确认和错误处理

## 注意事项

### ⚠️ 前提条件
- 需要连接钱包 (MetaMask)
- 需要在 Sepolia 测试网
- 需要有足够的 ETH 支付 gas 费用
- 需要有足够的 PNTs 用于转账

### 💰 Gas 费用
- 账户创建: ~0.01-0.02 ETH (取决于工厂类型)
- PNTs 转账: 标准 ERC20 转账费用
- ETH 转账: 标准转账费用

### 🔄 网络支持
- 目前支持 Sepolia 测试网
- 主网地址已配置，但需要测试验证

## 故障排除

### ❌ 常见问题

**地址计算失败**
- 检查钱包是否正确连接
- 确保在正确的网络 (Sepolia)

**账户创建失败**
- 检查 ETH 余额是否足够
- 确认工厂合约地址正确

**转账失败**
- 检查代币余额
- 确认新账户地址正确

**记录丢失**
- 浏览器数据被清除
- 使用隐私模式浏览

## 未来扩展

### 🔮 计划功能
- 支持主网部署
- 添加更多账户工厂选项
- 支持批量创建账户
- 添加账户管理功能 (重命名、标签等)

### 🔧 技术改进
- 添加账户导入/导出功能
- 支持更多网络
- 添加交易历史记录
- 集成钱包连接状态检测

---

## 📞 支持

如果在使用过程中遇到问题，请检查：
1. 浏览器控制台错误信息
2. 网络连接状态
3. 钱包连接状态
4. 合约地址配置

所有创建的账户都可以通过 Etherscan 独立验证。
